/*!
 * peer-sock
 * 
 * @author Wil Neeley <william.neeley@gmail.com> (https://github.com/Xaxis)
 * @version 1.0.0
 * @license MIT
 */
var PeerSock=function(a){return a=a||{},Object.assign(Object.create({}),{pc:null,channels:{},debug:a.debug||!1,PeerConnection:window.mozRTCPeerConnection||window.webkitRTCPeerConnection||window.RTCPeerConnection,IceCandidate:window.mozRTCIceCandidate||window.RTCIceCandidate||window.RTCIceCandidate,SessionDescription:window.mozRTCSessionDescription||window.RTCSessionDescription,getUserMedia:navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia,rtc_config:a.rtc_config||{iceServers:[{url:"stun:23.21.150.121"},{url:"stun:stun.l.google.com:19302"}]},rtc_options:a.rtc_options||{optional:[{DtlsSrtpKeyAgreement:!0}]},rtc_handlers:{onaddstream:a.onaddstream||function(a){this.PeerSock.debug&&console.log("PeerSock.rtc_handlers.onaddstream::",a)},ondatachannel:a.ondatachannel||function(a){this.PeerSock.debug&&console.log("PeerSock.rtc_handlers.ondatachannel::",a)},onicecandidate:a.onicecandidate||function(a){if(this.PeerSock.debug&&console.log("PeerSock.rtc_handlers.onicecandidate::",a),null!=a.candidate){var b=this,c=a.candidate,d=this.PeerSock.client_id,e=this.PeerSock.peer_id;this.PeerSock.signal.onmessage("PeerSock_IceCandidate",function(a){b.PeerSock.pc.addIceCandidate(new b.PeerSock.IceCandidate(a.message))}),this.PeerSock.signal.send("PeerSock_IceCandidate",e,d,{candidate:c.candidate,sdpMLineIndex:c.sdpMLineIndex}),this.onicecandidate=null}},oniceconnectionstatechange:a.oniceconnectionstatechange||function(a){this.PeerSock.debug&&console.log("PeerSock.rtc_handlers.oniceconnectionstatechange::",a)},onidentityresult:a.onidentityresult||function(a){this.PeerSock.debug&&console.log("PeerSock.rtc_handlers.onidentityresult::",a)},onidpassertionerror:a.onidpassertionerror||function(a){this.PeerSock.debug&&console.log("PeerSock.rtc_handlers.onidpassertionerror::",a)},onidpvalidationerror:a.onidpvalidationerror||function(a){this.PeerSock.debug&&console.log("PeerSock.rtc_handlers.onidpvalidationerror::",a)},onnegotiationneeded:a.onnegotiationneeded||function(a){this.PeerSock.debug&&console.log("PeerSock.rtc_handlers.onnegotiationneeded::",a)},onpeeridentity:a.onpeeridentity||function(a){this.PeerSock.debug&&console.log("PeerSock.rtc_handlers.onpeeridentity::",a)},onremovestream:a.onremovestream||function(a){this.PeerSock.debug&&console.log("PeerSock.rtc_handlers.onremovestream::",a)},onsignalstatechange:a.onsignalstatechange||function(a){this.PeerSock.debug&&console.log("PeerSock.rtc_handlers.onsignalstatechange::",a)}},dc_config:a.dc_config||{ordered:!0,reliable:!0},dc_handlers:{onopen:a.onopen||function(a){console.log(this),this.PeerSock.debug&&console.log("PeerSock.dc_handlers.onopen::",a)},onerror:a.onerror||function(a){this.PeerSock.debug&&console.log("PeerSock.dc_handlers.onerror::",a)},onmessage:a.onmessage||function(a){this.PeerSock.debug&&console.log("PeerSock.dc_handlers.onmessage::",a)},onclose:a.onclose||function(a){this.PeerSock.debug&&console.log("PeerSock.dc_handlers.onclose::",a)}},signal:a.signal||{socket:a.socket,send:function(a,b,c,d){this.socket.emit("MessageToPeer",{handler_id:a,peer_id:b,client_id:c,message:d})},onmessage:function(a,b){this.socket.on(a,function(a){b(a)})}},errorHandler:a.errorHandler||function(a){console.log(a)},newPeerConnection:function(a){a=a||{};var b=new this.PeerConnection(a.rtc_config||this.rtc_config,a.rtc_options||this.rtc_options),c=a.rtc_handlers||{},d={};for(var e in this.rtc_handlers)d[e]=c[e]||this.rtc_handlers[e],b[e]=d[e];return b.PeerSock=this,this.pc=b},newDataChannel:function(a){var b=this,c=a.connection||this.pc,d=a.dc_handlers||{},e={},f=function(){var a=Math.floor(9999*Math.random());return a in b.channels?void f():a}(),g=this.channels[a.channel_id]=c.createDataChannel(f,this.dc_config);for(var h in this.dc_handlers)e[h]=d[h]||this.dc_handlers[h],g[h]=e[h];return g.PeerSock=this,this.getDataChannel(a.channel_id)},getDataChannel:function(a){return this.channels[a]},setRemoteDescription:function(a,b,c){a.setRemoteDescription(new this.SessionDescription(b),function(){c&&c(a,b)},this.errorHandler)},createClientOffer:function(a,b){var c=this;a.createOffer(function(d){a.setLocalDescription(d,function(){b&&b(d)},c.errorHandler)},this.errorHandler)},answerPeerOffer:function(a,b,c){var d=this;a.setRemoteDescription(new this.SessionDescription(b),function(){a.createAnswer(function(b){a.setLocalDescription(b),c&&c(b)},d.errorHandler)},this.errorHandler)},newListeningChannel:function(a){var b=this;this.signal.onmessage(a.channel_id,function(c){var d=c.message;"offer"==d.type?(b.newPeerConnection({rtc_handlers:{ondatachannel:function(d){b.newDataChannel({channel:d.channel,channel_id:d.channel.label}),d.channel.onmessage=function(b){a.onMessage&&a.onMessage.call(this,{channel:d.channel,message:c,data:b.data,peer_id:c.peer_id})}}}}),b.client_id=c.peer_id,b.peer_id=c.client_id,b.answerPeerOffer(b.pc,d,function(d){b.signal.send(a.channel_id,c.peer_id,c.client_id,d)})):"answer"==d.type&&b.setRemoteDescription(b.pc,d)})},startListeningChannel:function(a){var b=this,c=this.pc?!0:!1,d=function(){},e=a.onOpen||a.send||d,f=a.onMessage||d,g=a.onClose||d,h=a.onError||d;c||this.newPeerConnection(),this.newDataChannel({channel_id:a.channel_id,connection:b.pc,dc_handlers:{onopen:function(c){e.call(this,{channel:b.channels[a.channel_id],peer_id:a.peer_id,event:c})},onmessage:function(c){f.call(this,{channel:b.channels[a.channel_id],peer_id:a.peer_id,data:c.data,event:c})},onclose:function(c){g.call(this,{channel:b.channels[a.channel_id],peer_id:a.peer_id,event:c})},onerror:function(c){h.call(this,{channel:b.channels[a.channel_id],peer_id:a.peer_id,event:c})}}}),this.client_id=a.client_id,this.peer_id=a.peer_id,c||this.createClientOffer(this.pc,function(c){b.signal.send(a.channel_id,a.peer_id,a.client_id,c)})}})};